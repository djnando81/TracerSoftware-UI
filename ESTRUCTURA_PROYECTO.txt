# Gu√≠a de Estructura y Est√°ndares ‚Äì TracerSoftware App

Esta gu√≠a define c√≥mo crear y mantener m√≥dulos con UI y API coherentes en TracerSoftware. √ösala como referencia completa para implementar cualquier m√≥dulo nuevo siguiendo los est√°ndares establecidos.

## ARQUITECTURA DEL SISTEMA

### Estructura de Proyecto
```
TracerSoftware/
‚îú‚îÄ‚îÄ API/ (ASP.NET Core Backend)
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/          # Endpoints REST con versionado v1
‚îÇ   ‚îú‚îÄ‚îÄ DTOs/                # Objetos de transferencia de datos
‚îÇ   ‚îú‚îÄ‚îÄ Models/              # Entidades de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ Services/            # L√≥gica de negocio
‚îÇ   ‚îú‚îÄ‚îÄ Authorization/       # Permisos y roles
‚îÇ   ‚îî‚îÄ‚îÄ Data/               # Contexto de Entity Framework
‚îú‚îÄ‚îÄ src/main/java/ (JavaFX Frontend)
‚îÇ   ‚îú‚îÄ‚îÄ com/tracersoftware/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <modulo>/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ model/       # DTOs del cliente
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/         # Servicios API
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ controller/  # Controladores JavaFX
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ common/          # Componentes reutilizables
‚îî‚îÄ‚îÄ src/main/resources/
    ‚îú‚îÄ‚îÄ <modulo>/fxml/       # Archivos FXML por m√≥dulo
    ‚îî‚îÄ‚îÄ css/                 # Estilos globales
```

### Flujo de Datos
1. **JavaFX UI** ‚Üí llama a **ApiService** 
2. **ApiService** ‚Üí consume **REST API**
3. **Controller** ‚Üí procesa con **Service** 
4. **Service** ‚Üí persiste con **Entity Framework**

## M√ìDULOS IMPLEMENTADOS

### ‚úÖ USUARIOS - COMPLETO
**Estado**: Sistema de gesti√≥n de usuarios con toggle de estado funcional
**Archivos Backend**:
- `API/Controllers/UsuariosController.cs` - Controller con CRUD completo + toggle
- `API/Models/Usuario.cs` - Entidad de usuario
- `API/DTOs/UsuarioDTO.cs` - DTO de transferencia
- `API/Authorization/Permisos.cs` - Permisos: UsuariosRead, UsuariosWrite, UsuariosDelete

**Archivos Frontend**:
- `src/main/java/com/tracersoftware/usuarios/controller/UsuariosListController.java`
- `src/main/java/com/tracersoftware/usuarios/api/UsuariosApiService.java`
- `src/main/resources/usuarios/usuarios_list.fxml` - Lista estandarizada con toggle

**Caracter√≠sticas implementadas**:
- ‚úÖ Toggle de estado activo/inactivo (`PUT /api/usuarios/{id}/toggle-estado`)
- ‚úÖ CRUD completo con validaci√≥n de permisos
- ‚úÖ UI estandarizada con SearchBar, ExportBar y PaginatorControl
- ‚úÖ SwitchToggleButton funcional para cambio de estado
- ‚úÖ Manejo de errores y mensajes de confirmaci√≥n

### ‚úÖ MATERIAS PRIMAS - COMPLETO
**Estado**: M√≥dulo de referencia con todas las funcionalidades est√°ndar
**Archivos Frontend**:
- `src/main/java/com/tracersoftware/materiasprimas/model/MateriaPrimaItem.java`
- `src/main/java/com/tracersoftware/materiasprimas/api/MateriasPrimasApiService.java`
- `src/main/java/com/tracersoftware/materiasprimas/controller/MateriasPrimasListController.java`
- `src/main/java/com/tracersoftware/materiasprimas/controller/MateriaPrimaFormController.java`
- `src/main/resources/materiasprimas/materiasprimas_list.fxml`
- `src/main/resources/materiasprimas/materiasprima_form.fxml`

**Caracter√≠sticas especiales**:
- ‚úÖ Scroll horizontal y vertical en DataGrid
- ‚úÖ Relaci√≥n con categor√≠as y unidades de medida
- ‚úÖ Gesti√≥n de stocks y costos
- ‚úÖ Formulario modal con validaci√≥n completa
- ‚úÖ ExportBar con datos completos y filtros

### ‚úÖ ROLES - COMPLETO  
**Estado**: Sistema de gesti√≥n de roles y permisos
**Archivos Frontend**:
- `src/main/java/com/tracersoftware/roles/model/RolItem.java`
- `src/main/java/com/tracersoftware/roles/api/RolesApiService.java`
- `src/main/java/com/tracersoftware/roles/controller/RolesListController.java`
- `src/main/java/com/tracersoftware/roles/controller/RolFormController.java`
- `src/main/resources/roles/roles_list.fxml`

**Caracter√≠sticas implementadas**:
- ‚úÖ CRUD completo de roles del sistema
- ‚úÖ Asignaci√≥n de permisos por rol
- ‚úÖ Toggle de estado activo/inactivo
- ‚úÖ UI estandarizada con todos los componentes obligatorios

### ‚úÖ CATEGOR√çAS MATERIA PRIMA - COMPLETO
**Estado**: Maestro de categor√≠as para clasificaci√≥n de materias primas  
**Archivos Frontend**:
- `src/main/java/com/tracersoftware/categoriasmateriaprima/`
- `src/main/resources/categoriasmateriaprima/categorias_list.fxml`

**Caracter√≠sticas implementadas**:
- ‚úÖ Gesti√≥n completa de categor√≠as
- ‚úÖ Relaci√≥n jer√°rquica con materias primas
- ‚úÖ Toggle de estado y exportaci√≥n

## COMPONENTES GLOBALES IMPLEMENTADOS

### üéØ CONTROLES REUTILIZABLES (100% Funcionales)

#### 1. **ExportBar** - Control de Exportaci√≥n Universal
- **Ubicaci√≥n**: `src/main/java/com/tracersoftware/common/controls/ExportBar.java`
- **Funcionalidades**:
  - ‚úÖ Exportaci√≥n a Excel (verde) - Formato .xlsx con estilos
  - ‚úÖ Exportaci√≥n a CSV (azul) - Separado por comas
  - ‚úÖ Exportaci√≥n a TXT (gris) - Texto plano delimitado por tabs
  - ‚úÖ Exportaci√≥n a PDF (morado) - Formato tabular profesional
  - ‚úÖ Modos: "Solo seleccionados" y "Todo (servidor)"
  - ‚úÖ Guardado autom√°tico con timestamp
  - ‚úÖ Integraci√≥n autom√°tica con cualquier TableView

#### 2. **SearchBar** - Buscador Universal
- **Ubicaci√≥n**: `src/main/java/com/tracersoftware/common/controls/SearchBar.java`
- **Funcionalidades**:
  - ‚úÖ B√∫squeda en tiempo real con debounce
  - ‚úÖ Filtrado local y delegaci√≥n a servidor
  - ‚úÖ Reinicio autom√°tico de paginaci√≥n
  - ‚úÖ Placeholder configurable

#### 3. **PaginatorControl** - Paginaci√≥n Est√°ndar
- **Ubicaci√≥n**: `src/main/java/com/tracersoftware/common/controls/PaginatorControl.java`
- **Funcionalidades**:
  - ‚úÖ Navegaci√≥n por p√°ginas con botones
  - ‚úÖ Selector de tama√±o de p√°gina (10, 25, 50, 100)
  - ‚úÖ Informaci√≥n de registros (X de Y elementos)
  - ‚úÖ Binding reactivo con propiedades JavaFX

#### 4. **SwitchToggleButton** - Toggle de Estado
- **Ubicaci√≥n**: `src/main/java/com/tracersoftware/common/controls/SwitchToggleButton.java`
- **Funcionalidades**:
  - ‚úÖ Bot√≥n tipo switch iOS/Android
  - ‚úÖ Estilos CSS responsivos (`css/toggle.css`)
  - ‚úÖ Integraci√≥n con endpoints de toggle
  - ‚úÖ Manejo autom√°tico de errores con reversi√≥n

#### 5. **ActiveToggleControl** - Toggle Avanzado con API
- **Ubicaci√≥n**: `src/main/java/com/tracersoftware/common/controls/ActiveToggleControl.java`
- **Funcionalidades**:
  - ‚úÖ Toggle con llamada autom√°tica a API
  - ‚úÖ Loading state y error handling
  - ‚úÖ Revert autom√°tico en caso de fallo

### üé® SISTEMA DE ESTILOS UNIFICADO

#### Botones Est√°ndar (buttons.css)
```css
/* Botones por Color */
.button-blue     /* Nuevo, Actualizar, CSV */
.button-green    /* Crear, Excel, Agregar */
.button-red      /* Eliminar, Cancelar */
.button-yellow   /* Editar, Modificar */
.button-gray     /* TXT, Neutros */
.button-purple   /* PDF, Premium */

/* Utilidades */
.btn-small       /* Botones compactos */
.icon-btn        /* Botones con iconos */
.btn-primary     /* Bot√≥n principal */

/* Estados de Acci√≥n */
.btn-action-create   /* Verde - Crear */
.btn-action-update   /* Azul - Actualizar */  
.btn-action-cancel   /* Rojo - Cancelar */
```

#### Layout Est√°ndar (modal.css)
```css
.modal-card      /* Contenedor principal del modal */
.modal-accent    /* Barra superior para drag */
.modal-header    /* Header con t√≠tulo */
.form-section    /* Secciones del formulario */
.field-label     /* Labels de campos */
.help-text       /* Texto de ayuda */
.status-label    /* Labels de estado */
```

## PATRONES DE IMPLEMENTACI√ìN OBLIGATORIOS

### üèóÔ∏è ESTRUCTURA DE M√ìDULOS

#### Estructura de Archivos por M√≥dulo
```
<modulo>/
‚îú‚îÄ‚îÄ model/
‚îÇ   ‚îú‚îÄ‚îÄ <Modulo>Item.java      # DTO principal del listado
‚îÇ   ‚îî‚îÄ‚îÄ <Modulo>Detail.java    # DTO detallado (opcional)
‚îú‚îÄ‚îÄ api/  
‚îÇ   ‚îî‚îÄ‚îÄ <Modulo>ApiService.java # Cliente REST para el m√≥dulo
‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îú‚îÄ‚îÄ <Modulo>ListController.java  # Controlador de listado
‚îÇ   ‚îú‚îÄ‚îÄ <Modulo>FormController.java  # Controlador de formulario
‚îÇ   ‚îî‚îÄ‚îÄ <Modulo>ViewController.java  # Controlador principal (opcional)
‚îî‚îÄ‚îÄ fxml/
    ‚îú‚îÄ‚îÄ <modulo>_list.fxml     # Vista de listado
    ‚îú‚îÄ‚îÄ <modulo>_form.fxml     # Modal de formulario
    ‚îî‚îÄ‚îÄ <modulo>_view.fxml     # Vista principal (opcional)
```

### üéØ ENDPOINTS API EST√ÅNDAR

#### Convenciones de Rutas (Backend ASP.NET Core)
```csharp
[Route("api/v1/<modulo-plural>")]           // Ruta principal v1
[Route("api/<modulo-legacy>")]              // Compatibilidad legacy

// Endpoints Obligatorios
[HttpGet]                                   // GET /api/v1/<modulo> - Listar
[HttpGet("{id}")]                          // GET /api/v1/<modulo>/{id} - Obtener
[HttpPost]                                 // POST /api/v1/<modulo> - Crear  
[HttpPut("{id}")]                          // PUT /api/v1/<modulo>/{id} - Actualizar
[HttpDelete("{id}")]                       // DELETE /api/v1/<modulo>/{id} - Eliminar

// Toggle de Estado (si aplica)
[HttpPut("{id}/toggle-estado")]            // PUT /api/v1/<modulo>/{id}/toggle-estado
[HttpPatch("{id}/toggle-activo")]          // PATCH /api/v1/<modulo>/{id}/toggle-activo
```

#### C√≥digos de Respuesta Est√°ndar
- **200 OK**: Consultas exitosas
- **201 Created**: Creaci√≥n exitosa  
- **204 No Content**: Actualizaci√≥n/eliminaci√≥n exitosa
- **400 Bad Request**: Errores de validaci√≥n
- **401 Unauthorized**: No autenticado
- **403 Forbidden**: Sin permisos
- **404 Not Found**: Recurso no existe
- **409 Conflict**: Conflictos de integridad
- **500 Internal Server Error**: Errores del sistema

### üîê SISTEMA DE PERMISOS

#### Estructura de Permisos por M√≥dulo
```csharp
public static class Permisos {
    // Por cada m√≥dulo: Read, Write, Delete
    public const string <Modulo>Read = "<Modulo>:Read";
    public const string <Modulo>Write = "<Modulo>:Write"; 
    public const string <Modulo>Delete = "<Modulo>:Delete";
}
```

#### Aplicaci√≥n en Controllers
```csharp
[HttpGet]
[Authorize(Policy = Permisos.<Modulo>Read)]

[HttpPost]
[Authorize(Policy = Permisos.<Modulo>Write)]

[HttpDelete("{id}")]
[Authorize(Policy = Permisos.<Modulo>Delete)]
```

## M√ìDULOS PENDIENTES DE IMPLEMENTACI√ìN

### üöß ALTA PRIORIDAD

#### 1. **ALMACENES**
- **Objetivo**: Gesti√≥n de ubicaciones de almacenamiento
- **Funcionalidades**:
  - CRUD de almacenes con ubicaciones
  - Capacidades y restricciones por almac√©n  
  - Asignaci√≥n de materias primas y productos
  - Control de acceso por usuario

#### 2. **INVENTARIO MATERIA PRIMA**
- **Objetivo**: Control de stock y movimientos
- **Funcionalidades**:
  - Stock actual por almac√©n y lote
  - Movimientos de entrada, salida y transferencias
  - Alertas de stock m√≠nimo/m√°ximo
  - Trazabilidad completa de lotes

#### 3. **ENTRADAS MATERIA PRIMA**
- **Objetivo**: Recepci√≥n y registro de materiales
- **Funcionalidades**:
  - Recepci√≥n contra √≥rdenes de compra
  - Control de calidad en recepci√≥n
  - Generaci√≥n autom√°tica de lotes
  - Distribuci√≥n a almacenes

#### 4. **√ìRDENES DE PEDIDO MATERIA PRIMA**
- **Objetivo**: Gesti√≥n de compras a proveedores
- **Funcionalidades**:
  - Creaci√≥n de √≥rdenes de compra
  - Seguimiento de estados (pendiente, enviado, recibido)
  - Integraci√≥n con proveedores y materias primas
  - Alertas de vencimiento

### üè≠ MEDIA PRIORIDAD

#### 5. **PRODUCTOS TERMINADOS**
- **Objetivo**: Cat√°logo de productos fabricados
- **Funcionalidades**:
  - Definici√≥n de productos y presentaciones
  - F√≥rmulas de producci√≥n (BOM)
  - Costos est√°ndar y precios
  - C√≥digos de barras y etiquetado

#### 6. **FORMULACIONES**
- **Objetivo**: Recetas y f√≥rmulas de producci√≥n
- **Funcionalidades**:
  - Definici√≥n de ingredientes y proporciones
  - Versionado de f√≥rmulas
  - Escalado autom√°tico de cantidades
  - Control de cambios y aprobaciones

#### 7. **√ìRDENES DE PRODUCCI√ìN**
- **Objetivo**: Planificaci√≥n y control de manufactura
- **Funcionalidades**:
  - Programaci√≥n de lotes de producci√≥n
  - Consumo de materias primas
  - Registro de rendimientos y mermas
  - Estados de progreso

#### 8. **CLIENTES**
- **Objetivo**: Gesti√≥n de cartera de clientes
- **Funcionalidades**:
  - Datos de contacto y facturaci√≥n
  - Historial de pedidos y productos
  - Clasificaci√≥n y segmentaci√≥n
  - Condiciones comerciales

### üìä BAJA PRIORIDAD

#### 9. **√ìRDENES DE SALIDA**
- **Objetivo**: Despacho de productos terminados
- **Funcionalidades**:
  - Preparaci√≥n de pedidos de clientes
  - Picking y packing
  - Control de calidad de salida
  - Documentaci√≥n de env√≠o

#### 10. **EMBALAJES**
- **Objetivo**: Gesti√≥n de envases y empaques
- **Funcionalidades**:
  - Cat√°logo de tipos de embalaje
  - Capacidades y restricciones
  - Costos y proveedores
  - Trazabilidad de uso

#### 11. **BAJAS MATERIA PRIMA**
- **Objetivo**: Control de desperdicios y descarte
- **Funcionalidades**:
  - Registro de causas de baja
  - Autorizaci√≥n y aprobaci√≥n
  - Impacto en inventarios
  - Reportes de mermas

#### 12. **INVENTARIO PRODUCTOS TERMINADOS**
- **Objetivo**: Control de stock de productos fabricados
- **Funcionalidades**:
  - Stock por almac√©n y lote
  - Movimientos y transferencias
  - Fechas de vencimiento
  - Reservas y disponibilidad

## ROADMAP DE IMPLEMENTACI√ìN

### üìÖ FASE 1: FUNDACI√ìN (4-6 semanas)
1. ‚úÖ **Usuarios** - Sistema de acceso y permisos
2. ‚úÖ **Roles** - Gesti√≥n de permisos por rol  
3. ‚úÖ **Materias Primas** - Cat√°logo base de materiales
4. ‚úÖ **Categor√≠as MP** - Clasificaci√≥n de materiales
5. ‚úÖ **Proveedores** - Cartera de suministradores

### üìÖ FASE 2: INVENTARIOS (6-8 semanas)  
6. üöß **Almacenes** - Ubicaciones de almacenamiento
7. üöß **Inventario MP** - Control de stocks y movimientos
8. üöß **Entradas MP** - Recepci√≥n de materiales
9. üöß **√ìrdenes Pedido MP** - Compras a proveedores

### üìÖ FASE 3: PRODUCCI√ìN (8-10 semanas)
10. üöß **Productos Terminados** - Cat√°logo de productos
11. üöß **Formulaciones** - Recetas de fabricaci√≥n
12. üöß **√ìrdenes de Producci√≥n** - Control de manufactura

### üìÖ FASE 4: COMERCIALIZACI√ìN (6-8 semanas)
13. üöß **Clientes** - Gesti√≥n de cartera
14. üöß **√ìrdenes de Salida** - Despacho de productos
15. üöß **Inventario PT** - Stock de productos terminados

### üìÖ FASE 5: OPTIMIZACI√ìN (4-6 semanas)
16. üöß **Embalajes** - Gesti√≥n de envases
17. üöß **Bajas MP** - Control de desperdicios
18. üöß **Reportes Avanzados** - Analytics y KPIs
19. üöß **Integraci√≥n IoT** - Dispositivos y sensores

## GU√çA DE IMPLEMENTACI√ìN PASO A PASO

### üéØ CREAR UN NUEVO M√ìDULO

#### Paso 1: Definir el Modelo de Datos
```java
// 1. Crear el DTO principal
public class <Modulo>Item {
    private int id;
    private String nombre;
    private boolean activo;
    // ... campos espec√≠ficos del m√≥dulo
    
    // Getters y setters
}
```

#### Paso 2: Implementar el API Service
```java
// 2. Crear el cliente REST  
public class <Modulo>ApiService {
    private final ApiClient api = new ApiClient();
    
    public List<<Modulo>Item> listAll() throws Exception {
        // Implementar consumo de API
    }
    
    public JsonNode toggleEstado(int id, boolean activo) throws Exception {
        // Implementar toggle si aplica
    }
    
    // ... otros m√©todos CRUD
}
```

#### Paso 3: Crear el Controller de Listado
```java
// 3. Implementar controlador con componentes obligatorios
public class <Modulo>ListController implements ViewLifecycle {
    @FXML private TableView<<Modulo>Item> table;
    @FXML private HBox exportBarContainer;  // OBLIGATORIO
    @FXML private PaginatorControl paginator;
    @FXML private SearchBar searchBar;
    
    @FXML public void initialize() {
        // Configurar ExportBar OBLIGATORIO
        setupExportBar();
        
        // Configurar tabla con columnas est√°ndar
        setupTable();
        
        // Configurar botones con estilos est√°ndar  
        setupButtons();
    }
}
```

#### Paso 4: Dise√±ar la Vista FXML
```xml
<!-- 4. Crear FXML con estructura est√°ndar -->
<BorderPane>
    <center>
        <VBox spacing="8" style="-fx-padding:12;">
            <!-- Header con t√≠tulo y b√∫squeda -->
            <HBox spacing="8" alignment="CENTER_LEFT">
                <Label text="Gesti√≥n de <M√≥dulo>" styleClass="title-label"/>
                <Region HBox.hgrow="ALWAYS"/>
                <SearchBar fx:id="searchBar"/>
                <Button fx:id="btnNuevo" text="‚ûï Nuevo"/>
            </HBox>
            
            <!-- Tabla principal -->
            <TableView fx:id="table" VBox.vgrow="ALWAYS"/>
            
            <!-- ExportBar (OBLIGATORIO) -->
            <HBox fx:id="exportBarContainer" alignment="CENTER_RIGHT"/>
            
            <!-- Paginador -->
            <PaginatorControl fx:id="paginator"/>
        </VBox>
    </center>
</BorderPane>
```

#### Paso 5: Implementar el Backend
```csharp
// 5. Crear controller ASP.NET Core
[ApiController]
[Route("api/v1/<modulo-plural>")]
public class <Modulo>Controller : ControllerBase {
    
    [HttpGet]
    [Authorize(Policy = Permisos.<Modulo>Read)]
    public async Task<List<<Modulo>DTO>> GetAll() {
        // Implementar listado
    }
    
    [HttpPut("{id}/toggle-estado")]
    [Authorize(Policy = Permisos.<Modulo>Write)]  
    public async Task<IActionResult> ToggleEstado(int id) {
        // Implementar toggle
    }
    
    // ... otros endpoints CRUD
}
```

#### Paso 6: Agregar al Men√∫
```json
// 6. Actualizar menu-manifest.json
{
  "items": [
    {
      "id": "<modulo>",
      "label": "Gesti√≥n de <M√≥dulo>", 
      "icon": "fa5s-icon",
      "route": "/<modulo>_list"
    }
  ]
}
```

### ‚úÖ CHECKLIST DE IMPLEMENTACI√ìN

#### Frontend (JavaFX)
- [ ] DTO principal con todos los campos del backend
- [ ] ApiService con m√©todos CRUD completos
- [ ] ListController con ExportBar obligatorio
- [ ] FormController con validaci√≥n y loading
- [ ] **Callback setOnSaved() implementado en FormController**
- [ ] **Callback configurado en openForm() del ListController**
- [ ] FXML con estructura est√°ndar y componentes obligatorios
- [ ] Estilos CSS aplicados seg√∫n est√°ndares
- [ ] Manejo de errores con MessageToast
- [ ] Toggle de estado (si aplica)
- [ ] **Actualizaci√≥n autom√°tica de lista despu√©s de CRUD**

#### Backend (ASP.NET Core)  
- [ ] Entity model con relaciones correctas
- [ ] DTO para transferencia de datos
- [ ] Service con l√≥gica de negocio
- [ ] Controller con endpoints est√°ndar
- [ ] Permisos definidos y aplicados
- [ ] Validaci√≥n de datos de entrada
- [ ] Manejo de errores con c√≥digos HTTP correctos
- [ ] Endpoint de toggle (si aplica)

#### Integraci√≥n
- [ ] Comunicaci√≥n API funcionando
- [ ] Manejo de errores end-to-end
- [ ] Entrada en men√∫ de navegaci√≥n  
- [ ] Permisos configurados en roles
- [ ] Pruebas de funcionalidad completa
- [ ] **Actualizaci√≥n autom√°tica de DataGrid** (Ver secci√≥n espec√≠fica)

Con esta gu√≠a actualizada, cualquier desarrollador puede implementar un m√≥dulo nuevo siguiendo los patrones establecidos y garantizando la consistencia en toda la aplicaci√≥n.

## üîÑ ACTUALIZACI√ìN AUTOM√ÅTICA DE DATAGRIDS

### Patr√≥n de Actualizaci√≥n Inmediata
Para garantizar que las listas se actualicen inmediatamente despu√©s de crear, editar o eliminar registros, se debe implementar el siguiente patr√≥n est√°ndar:

#### 1. **Callback en FormController** (OBLIGATORIO)
```java
public class <Modulo>FormController {
    private Runnable onSavedCallback; // Callback para ejecutar cuando se guarde exitosamente
    
    // OBLIGATORIO: M√©todo para establecer callback de actualizaci√≥n
    public void setOnSaved(Runnable callback) {
        this.onSavedCallback = callback;
    }
    
    // En el m√©todo de guardado exitoso:
    saveTask.setOnSucceeded(e -> {
        // Actualizar datos locales
        currentItem = item;
        
        // Mostrar mensaje de √©xito
        MessageToast.show(null, "Registro guardado exitosamente", MessageToast.ToastType.SUCCESS);
        result = true;
        
        // EJECUTAR CALLBACK PARA ACTUALIZAR LISTA INMEDIATAMENTE
        if (onSavedCallback != null) {
            onSavedCallback.run();
        }
        
        closeWindow();
    });
}
```

#### 2. **Implementaci√≥n en ListController** (OBLIGATORIO)
```java
public class <Modulo>ListController {
    private void openForm(<Modulo>Item item) {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/.../form.fxml"));
            Parent root = loader.load();
            <Modulo>FormController controller = loader.getController();
            
            // ESTABLECER CALLBACK PARA ACTUALIZAR LISTA INMEDIATAMENTE
            controller.setOnSaved(() -> load());
            
            // Configurar modo (crear/editar)
            if (item != null) {
                controller.edit(item);
            } else {
                controller.create();
            }
            
            // Mostrar modal
            ModalUtils.showModalAndWait(ownerStage, root, title);
            
        } catch (Exception ex) { 
            MessageToast.showSystemError(null, "Error: " + ex.getMessage()); 
        }
    }
}
```

#### 3. **Beneficios del Patr√≥n**
- ‚úÖ **Actualizaci√≥n inmediata**: La lista se actualiza tan pronto como se guarda
- ‚úÖ **No requiere validaci√≥n**: No depende de verificar si el modal fue cancelado
- ‚úÖ **Consistencia**: Siempre muestra los datos m√°s recientes
- ‚úÖ **Mejor UX**: El usuario ve los cambios instant√°neamente
- ‚úÖ **Menos c√≥digo**: Elimina la necesidad de verificar estados del formulario

#### 4. **Casos de Uso Cubiertos**
- **Crear nuevo registro**: Lista se actualiza mostrando el nuevo elemento
- **Editar registro existente**: Lista se actualiza mostrando los cambios
- **Eliminar registro**: Lista se actualiza removiendo el elemento (usando callback en confirmaci√≥n)
- **Toggle de estado**: Lista se actualiza mostrando el nuevo estado

#### 5. **Implementaci√≥n para Eliminaci√≥n**
```java
private void deleteItem(<Modulo>Item item) {
    Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
    alert.setTitle("Confirmar eliminaci√≥n");
    alert.setHeaderText("¬øEst√° seguro de eliminar este registro?");
    
    alert.showAndWait().ifPresent(response -> {
        if (response == ButtonType.OK) {
            Task<Void> deleteTask = new Task<>() {
                @Override protected Void call() throws Exception {
                    service.delete(item.getId());
                    return null;
                }
            };
            deleteTask.setOnSucceeded(e -> {
                MessageToast.show(null, "Registro eliminado exitosamente", MessageToast.ToastType.SUCCESS);
                load(); // ACTUALIZAR LISTA INMEDIATAMENTE
            });
            deleteTask.setOnFailed(e -> {
                MessageToast.showSystemError(null, "Error al eliminar");
            });
            new Thread(deleteTask, "<modulo>-delete").start();
        }
    });
}
```

#### 6. **M√©todo load() Est√°ndar** (OBLIGATORIO)
```java
private void load() {
    Task<List<<Modulo>Item>> task = new Task<>() { 
        @Override protected List<<Modulo>Item> call() throws Exception { 
            return service.listAll(); 
        } 
    };
    task.setOnSucceeded(e -> { 
        full.clear(); 
        if (task.getValue() != null) full.addAll(task.getValue()); 
        applyPage(); // Reaplicar filtros y paginaci√≥n
    });
    task.setOnFailed(e -> {
        MessageToast.showSystemError(null, "Error cargando datos: " + 
            (task.getException() == null ? "" : task.getException().getMessage()));
    });
    new Thread(task, "<modulo>-load").start();
}
```

### üéØ Reglas de Implementaci√≥n

#### ‚úÖ HACER (Buenas Pr√°cticas)
- Usar `setOnSaved(Runnable callback)` en todos los formularios
- Llamar al callback inmediatamente despu√©s del √©xito de guardado
- Usar `load()` como callback est√°ndar para recargar completamente
- Implementar loading as√≠ncrono con `Task` para no bloquear la UI
- Mostrar mensajes de √©xito antes de cerrar el formulario
- Preservar filtros y paginaci√≥n actual despu√©s de recargar

#### ‚ùå NO HACER (Anti-patrones)
- No verificar `isCancelled()` y `getResult()` para decidir si actualizar
- No recargar solo cuando el modal retorna un resultado exitoso
- No usar `Platform.runLater()` innecesario para operaciones s√≠ncronas simples
- No actualizar solo elementos espec√≠ficos (mejor recargar completo)
- No ignorrar errores de recarga despu√©s de guardado exitoso

### üìã Checklist de Actualizaci√≥n Autom√°tica

#### Para FormController:
- [ ] Variable `onSavedCallback` declarada
- [ ] M√©todo `setOnSaved(Runnable callback)` implementado
- [ ] Callback ejecutado en `setOnSucceeded` del Task de guardado
- [ ] Callback ejecutado DESPU√âS de mostrar mensaje de √©xito
- [ ] Callback ejecutado ANTES de cerrar ventana

#### Para ListController:
- [ ] Callback `() -> load()` establecido antes de mostrar modal
- [ ] M√©todo `load()` implementa recarga as√≠ncrona completa
- [ ] M√©todo `applyPage()` preserva filtros y paginaci√≥n
- [ ] Eliminaci√≥n tambi√©n llama a `load()` despu√©s del √©xito
- [ ] Toggle de estado maneja actualizaci√≥n en caso de error

#### Para Integraci√≥n:
- [ ] Modal se abre correctamente con callback configurado
- [ ] Creaci√≥n de nuevos registros actualiza lista inmediatamente
- [ ] Edici√≥n de registros actualiza lista inmediatamente  
- [ ] Eliminaci√≥n actualiza lista inmediatamente
- [ ] No hay demora perceptible entre guardado y actualizaci√≥n
- [ ] Filtros y paginaci√≥n se mantienen despu√©s de actualizar

## COMPONENTES OBLIGATORIOS PARA M√ìDULOS

### 1. ExportBar (OBLIGATORIO en todos los listados)
- **Ubicaci√≥n**: Despu√©s de la tabla principal y antes del PaginatorControl, alineado a la derecha
- **Contenedor**: `<HBox fx:id="exportBarContainer" spacing="8" alignment="CENTER_RIGHT" />`
- **Implementaci√≥n**:
  ```java
  com.tracersoftware.common.controls.ExportBar exportBar = 
      new com.tracersoftware.common.controls.ExportBar(table, "nombre_modulo", () -> service.listAll());
  ```
- **Estilos autom√°ticos**: 
  - Excel: bot√≥n verde (`button-green`)
  - CSV: bot√≥n azul (`button-blue`) 
  - TXT: bot√≥n gris (`button-gray`)
  - PDF: bot√≥n morado (`button-purple`)
- **Funcionalidades**: Solo seleccionados, Todo (servidor), guardado autom√°tico con timestamp

### 2. Estilos de Botones (OBLIGATORIOS)
- **Bot√≥n Nuevo**: `button-blue`, `btn-primary`, `icon-btn` + texto "‚ûï Nuevo"
- **Bot√≥n Editar**: `btn-small`, `button-yellow`, `icon-btn`
- **Bot√≥n Eliminar**: `btn-small`, `button-red`, `icon-btn`
- **Bot√≥n Crear**: `btn-action-create` (verde)
- **Bot√≥n Actualizar**: `btn-action-update` (azul)
- **Bot√≥n Cancelar**: `btn-action-cancel` (rojo)

### 3. TableView con Columnas Est√°ndar (OBLIGATORIO)
- **ID**: Primera columna, ancho 80px
- **Nombre**: Columna principal, ancho 200px
- **Estado/Activo**: SwitchToggleButton, ancho 100px
- **Acciones**: √öltima columna, botones Editar/Eliminar, ancho 150px
- **Configuraci√≥n**: `CONSTRAINED_RESIZE_POLICY_FLEX_LAST_COLUMN`

### 4. SwitchToggleButton para Estados (OBLIGATORIO si hay campo activo/estado)
- **Clase CSS**: `cell-switch-btn`
- **Dimensiones**: 48x26 px
- **Endpoint**: `PUT/PATCH {id}/toggle-estado` o `{id}/toggle-activo`
- **Manejo de errores**: Revertir estado en UI si falla

### 5. Estructura de Layout (OBLIGATORIO)
```xml
<VBox spacing="8" style="-fx-padding:12;" fillWidth="true">
    <!-- Header con t√≠tulo, SearchBar y bot√≥n Nuevo -->
    <HBox spacing="8" alignment="CENTER_LEFT">
        <Label text="T√≠tulo del M√≥dulo" style="-fx-font-size:16px; -fx-font-weight:bold;" />
        <Region HBox.hgrow="ALWAYS" />
        <SearchBar fx:id="searchBar" />
        <Button fx:id="btnNuevo" text="Nuevo" />
    </HBox>
    
    <!-- Tabla principal -->
    <TableView fx:id="table" VBox.vgrow="ALWAYS">
        <!-- Columnas seg√∫n el DTO -->
    </TableView>
    
    <!-- OBLIGATORIO: Contenedor para ExportBar (alineado a la derecha) ANTES del paginador -->
    <HBox fx:id="exportBarContainer" spacing="8" alignment="CENTER_RIGHT" />
    
    <!-- OBLIGATORIO: Paginador al final -->
    <PaginatorControl fx:id="paginator" />
</VBox>
```

### 6. Formularios Modales (OBLIGATORIO)
```xml
<VBox fx:id="root" spacing="12.0" prefHeight="600.0" prefWidth="800.0">
    <!-- HEADER OBLIGATORIO -->
    <HBox alignment="CENTER_LEFT" spacing="12.0" styleClass="header-container">
        <Label fx:id="lblTitle" styleClass="title-label" text="Nuevo/Editar Elemento" />
        <Region HBox.hgrow="ALWAYS" />
    </HBox>

    <!-- FORMULARIO OBLIGATORIO con ScrollPane -->
    <ScrollPane fitToWidth="true" VBox.vgrow="ALWAYS">
        <VBox spacing="16.0">
            <!-- Informaci√≥n General -->
            <VBox spacing="12.0" styleClass="form-section">
                <Label styleClass="section-label" text="Informaci√≥n General" />
                <GridPane hgap="12.0" vgap="12.0">
                    <!-- Campos principales aqu√≠ -->
                </GridPane>
            </VBox>
            
            <!-- Asociaciones con ListView (si aplica) -->
            <VBox spacing="12.0" styleClass="form-section">
                <HBox alignment="CENTER_LEFT" spacing="12.0">
                    <Label styleClass="section-label" text="Elementos Asociados" />
                    <Region HBox.hgrow="ALWAYS" />
                    <Button fx:id="btnAgregar" styleClass="button-green,btn-small,icon-btn" text="‚ûï Agregar" />
                    <Button fx:id="btnQuitar" styleClass="button-red,btn-small,icon-btn" text="‚ûñ Quitar" />
                </HBox>
                <VBox spacing="8.0">
                    <Label styleClass="field-label" text="Elementos seleccionados:" />
                    <ListView fx:id="listElementos" prefHeight="180.0" styleClass="list-view" />
                    <Label fx:id="lblCount" styleClass="help-text" text="0 elementos asociados" />
                </VBox>
            </VBox>
            
            <!-- Estado OBLIGATORIO -->
            <VBox spacing="8.0" styleClass="form-section">
                <Label styleClass="section-label" text="Estado" />
                <HBox alignment="CENTER_LEFT" spacing="12.0">
                    <Label styleClass="field-label" text="Activo:" />
                    <SwitchToggleButton fx:id="swActivo" />
                    <Label fx:id="lblEstado" styleClass="status-label" text="Activo" />
                </HBox>
            </VBox>
        </VBox>
    </ScrollPane>

    <!-- BOTONES OBLIGATORIOS -->
    <HBox alignment="CENTER_RIGHT" spacing="12.0" styleClass="button-bar">
        <Button fx:id="btnCancelar" styleClass="button-gray,btn-secondary" text="Cancelar" />
        <Button fx:id="btnGuardar" styleClass="button-blue,btn-primary" text="üíæ Guardar" />
    </HBox>
</VBox>
```

### 7. Patrones de Controller (OBLIGATORIOS)

#### Listado Controller:
```java
@FXML private javafx.scene.layout.HBox exportBarContainer; // OBLIGATORIO

@FXML public void initialize() {
    // Configuraci√≥n de tabla y columnas...
    
    // ExportBar OBLIGATORIO
    if (exportBarContainer != null) {
        com.tracersoftware.common.controls.ExportBar exportBar = 
            new com.tracersoftware.common.controls.ExportBar(table, "nombre_modulo", () -> service.listAll());
        javafx.scene.layout.Region spacer = new javafx.scene.layout.Region();
        javafx.scene.layout.HBox.setHgrow(spacer, javafx.scene.layout.Priority.ALWAYS);
        exportBarContainer.getChildren().addAll(spacer, exportBar);
    }
    
    // Bot√≥n Nuevo OBLIGATORIO
    if (btnNuevo != null) {
        btnNuevo.getStyleClass().addAll("button-blue", "btn-primary", "icon-btn");
        btnNuevo.setText("‚ûï Nuevo");
        btnNuevo.setOnAction(e -> openForm(null));
    }
}
```

#### Form Controller:
```java
private boolean isEdit = false;

public void edit(ItemType item) {
    this.isEdit = true;
    this.currentItem = item;
    // Cargar datos en campos
    lblTitle.setText("Editar " + entityName);
    btnSave.setText("Actualizar");
    btnSave.getStyleClass().removeAll("btn-action-create");
    btnSave.getStyleClass().add("btn-action-update");
}
```

### 8. Patr√≥n ListView para Asociaciones (OBLIGATORIO para relaciones m√∫ltiples)

#### FXML para ListView de asociaciones:
```xml
<VBox spacing="12.0" styleClass="form-section">
    <HBox alignment="CENTER_LEFT" spacing="12.0">
        <Label styleClass="section-label" text="Elementos Asociados" />
        <Region HBox.hgrow="ALWAYS" />
        <Button fx:id="btnAgregar" styleClass="button-green,btn-small,icon-btn" text="‚ûï Agregar" />
        <Button fx:id="btnQuitar" styleClass="button-red,btn-small,icon-btn" text="‚ûñ Quitar" />
    </HBox>
    
    <VBox spacing="8.0">
        <Label styleClass="field-label" text="Elementos seleccionados:" />
        <ListView fx:id="listElementos" prefHeight="180.0" styleClass="list-view" />
        <Label fx:id="lblCount" styleClass="help-text" text="0 elementos asociados" />
    </VBox>
</VBox>
```

#### Controller para ListView:
```java
@FXML private ListView<ElementType> listElementos;
@FXML private Button btnAgregar;
@FXML private Button btnQuitar;
@FXML private Label lblCount;

private final ObservableList<ElementType> elementos = FXCollections.observableArrayList();

@FXML public void initialize() {
    // Configuraci√≥n de ListView OBLIGATORIA
    if (listElementos != null) {
        listElementos.setItems(elementos);
        
        // Cell factory personalizada OBLIGATORIA
        listElementos.setCellFactory(listView -> new ListCell<ElementType>() {
            @Override
            protected void updateItem(ElementType item, boolean empty) {
                super.updateItem(item, empty);
                if (empty || item == null) {
                    setText(null);
                    setGraphic(null);
                } else {
                    // Formato personalizado seg√∫n el tipo de elemento
                    String display = String.format("%s - %s (Info adicional)",
                        item.getNombre(), item.getCategoria());
                    setText(display);
                    
                    // Estilo seg√∫n estado
                    setStyle(item.isActivo() ? "-fx-text-fill: #2d3748;" : 
                            "-fx-text-fill: #a0aec0; -fx-font-style: italic;");
                }
            }
        });
        
        // Listener para actualizar contador
        elementos.addListener((ListChangeListener<ElementType>) c -> updateCount());
    }
    
    // Botones OBLIGATORIOS
    if (btnAgregar != null) btnAgregar.setOnAction(e -> agregarElemento());
    if (btnQuitar != null) btnQuitar.setOnAction(e -> quitarElemento());
    
    updateCount();
}

private void updateCount() {
    if (lblCount != null) {
        int count = elementos.size();
        lblCount.setText(count + " elementos asociados");
    }
}

private void agregarElemento() {
    try {
        // Cargar modal est√°ndar OBLIGATORIO
        javafx.fxml.FXMLLoader loader = new javafx.fxml.FXMLLoader(
            getClass().getResource("/modulo/fxml/elemento_modal.fxml"));
        javafx.scene.Parent root = loader.load();
        ElementoModalController controller = loader.getController();
        
        // Mostrar modal usando ModalUtils est√°ndar OBLIGATORIO
        com.tracersoftware.common.ui.ModalUtils.showModalAndWait(
            null, root, "Nuevo Elemento");
        
        // Verificar resultado OBLIGATORIO
        if (!controller.isCancelled() && controller.getResult() != null) {
            ElementType nuevoElemento = controller.getResult();
            elementos.add(nuevoElemento);
            MessageToast.show(null, "Elemento agregado exitosamente", MessageToast.ToastType.SUCCESS);
        }
        
    } catch (Exception ex) {
        MessageToast.showSystemError(null, "No se pudo abrir el formulario: " + ex.getMessage());
    }
}
```

### 9. Modal Est√°ndar para Subformularios (OBLIGATORIO)

#### FXML del Modal:
```xml
<BorderPane xmlns:fx="http://javafx.com/fxml/1" fx:controller="com.modulo.controller.ElementoModalController" styleClass="modal-card">
    <top>
        <Pane minHeight="15" prefHeight="15" maxHeight="15" styleClass="modal-accent" />
    </top>
    <center>
        <VBox spacing="4">
            <HBox styleClass="modal-header">
                <Label fx:id="lblTitle" text="Nuevo Elemento" />
            </HBox>
            <StackPane>
                <GridPane hgap="10" vgap="10">
                    <padding><Insets top="14" right="14" bottom="14" left="14" /></padding>
                    <columnConstraints>
                        <ColumnConstraints halignment="RIGHT" minWidth="110" prefWidth="120" />
                        <ColumnConstraints hgrow="ALWAYS" minWidth="240" prefWidth="300" />
                    </columnConstraints>
                    
                    <!-- Campos del formulario -->
                    <Label text="Campo:" GridPane.rowIndex="0" GridPane.columnIndex="0" />
                    <TextField fx:id="txtCampo" GridPane.rowIndex="0" GridPane.columnIndex="1" prefWidth="300" />
                    
                    <Label fx:id="lblError" textFill="red" wrapText="true" visible="false" managed="false" 
                           GridPane.rowIndex="8" GridPane.columnIndex="0" GridPane.columnSpan="2" />
                    
                    <!-- BOTONES OBLIGATORIOS con estilos est√°ndar -->
                    <HBox spacing="10" alignment="CENTER_RIGHT" GridPane.rowIndex="9" GridPane.columnIndex="1">
                        <ProgressIndicator fx:id="progress" prefWidth="20" prefHeight="20" visible="false" />
                        <Button fx:id="btnSave" text="Crear" styleClass="btn-action-create" />
                        <Button fx:id="btnCancel" text="Cancelar" styleClass="btn-action-cancel" />
                    </HBox>
                </GridPane>
                <AnchorPane fx:id="overlay" visible="false" pickOnBounds="false" style="-fx-background-color: rgba(0,0,0,0.35);">
                    <children><ProgressIndicator fx:id="overlayProgress" prefWidth="64" prefHeight="64" /></children>
                </AnchorPane>
            </StackPane>
        </VBox>
    </center>
</BorderPane>
```

#### Controller del Modal:
```java
public class ElementoModalController {
    @FXML private TextField txtCampo;
    @FXML private Button btnSave;
    @FXML private Button btnCancel;
    @FXML private Label lblError;
    
    private ElementType result;
    private boolean cancelled = true;
    
    @FXML public void initialize() {
        // OBLIGATORIO: Configuraci√≥n est√°ndar de botones
        if (btnSave != null) btnSave.setOnAction(e -> save());
        if (btnCancel != null) btnCancel.setOnAction(e -> cancel());
        setupValidation();
    }
    
    @FXML private void save() {
        if (!validateFields()) return;
        
        // Crear objeto resultado
        result = new ElementType();
        // Mapear campos...
        
        cancelled = false;
        closeWindow();
    }
    
    @FXML private void cancel() {
        cancelled = true;
        result = null;
        closeWindow();
    }
    
    // M√©todos getter OBLIGATORIOS
    public ElementType getResult() { return result; }
    public boolean isCancelled() { return cancelled; }
}
```

## M√≥dulos y carpetas
- Cada m√≥dulo tiene: `dto/`, `service/`, `controller/`, `fxml/`.
- Recursos por m√≥dulo: `src/main/resources/<modulo>/fxml/‚Ä¶`
- C√≥digo Java: `src/main/java/com/tracersoftware/<modulo>/‚Ä¶`

## Controles comunes reutilizables
- Exportaci√≥n: `ExportBar` (Excel/CSV/TXT/PDF)
  - `src/main/java/com/tracersoftware/common/controls/ExportBar.java`
  - Muestra "Solo seleccionados" y "Todo (servidor)". Insertar sobre el paginador, a la derecha.

- Paginaci√≥n: `PaginatorControl`
  - `src/main/java/com/tracersoftware/common/controls/PaginatorControl.java`
  - Props: `pageIndexProperty()`, `pageSizeProperty()`, `setTotalItems(int)`.

- Buscador: `SearchBar`
  - `src/main/java/com/tracersoftware/common/controls/SearchBar.java`
  - `textProperty()` para filtrar en memoria o delegar al servidor.

- Toggle de estado: `SwitchToggleButton`
  - `common/controls/SwitchToggleButton(.java|Skin.java)`; estilos en `css/toggle.css`/`css/responsive-toggle.css`.
  - Uso t√≠pico: columna "Activo/Activa" con endpoint `PUT/PATCH {id}/toggle-estado`.

## Estilos
- CSS global botones: `src/main/resources/com/tracersoftware/common/controls/buttons.css`
  - Clases: `btn-action-create` (Crear), `btn-action-update` (Actualizar), `btn-action-cancel` (Cancelar)
  - Base: `.button-blue`, `.button-red`, `.button-green`, `.button-yellow`, `.button-gray`
  - Utilitarios: `.btn-small`, `.icon-btn`
- Bot√≥n "Nuevo" en listados (desde controller):
  `btnNew.getStyleClass().addAll("button-blue","btn-primary","icon-btn"); btnNew.setText("‚ûï Nuevo");`

## Estilos
- CSS global botones: `src/main/resources/com/tracersoftware/common/controls/buttons.css`
  - Clases: `btn-action-create` (Crear), `btn-action-update` (Actualizar), `btn-action-cancel` (Cancelar)
  - Base: `.button-blue`, `.button-red`, `.button-green`, `.button-yellow`, `.button-gray`
  - Utilitarios: `.btn-small`, `.icon-btn`
- Bot√≥n ‚ÄúNuevo‚Äù en listados (desde controller):
  `btnNew.getStyleClass().addAll("button-blue","btn-primary","icon-btn"); btnNew.setText("‚ûï Nuevo");`

## Patr√≥n de Listados (TableView)
- HBox superior: spacer + `SearchBar` + bot√≥n ‚Äú‚ûï Nuevo‚Äù.
- `TableView` con columnas reales del DTO.
- Columna ‚ÄúAcciones‚Äù: botones ‚ÄúEditar‚Äù (amarillo) y ‚ÄúEliminar‚Äù (rojo).
- Columna de estado con `SwitchToggleButton` llamando a `toggle-estado`.
- `PaginatorControl` al final.
- Insertar `ExportBar` justo encima del paginador, alineada a la derecha.

## Patr√≥n de Formularios (modales)
- Estructura: `BorderPane` ‚Üí `.modal-accent` (barra superior) + `.modal-header` + `StackPane` (grid + overlay).
- Botones: derecha, `btn-action-create` / `btn-action-update` + `btn-action-cancel`.
- Modal sin decoraci√≥n: `ModalUtils.showModalAndWait(owner, root, title)` (drag por `.modal-accent`).
- En edici√≥n: texto ‚ÄúActualizar‚Äù + clase `btn-action-update`.

## ESTRUCTURA DEL MEN√ö Y NAVEGACI√ìN

### Configuraci√≥n del Men√∫
- **Archivo**: `src/main/resources/menu-manifest.json`
- **Carga**: `MenuLoader.loadFromResource("/menu-manifest.json")`
- **Constructor**: `MenuBarBuilder.build()` genera el sidebar din√°mico

### Estructura JSON del Men√∫
```json
{
  "title": "Tracer Dashboard",
  "items": [
    // Elementos de primer nivel (men√∫s principales)
    { 
      "id": "identificador_√∫nico", 
      "label": "Texto Visible", 
      "icon": "fa5s-icono", 
      "route": "/ruta_directa" 
    },
    // Men√∫s con submen√∫s (grupos colapsables)
    { 
      "id": "grupo_principal", 
      "label": "Grupo Principal", 
      "icon": "fa5s-icono-grupo", 
      "children": [
        { "id": "sub1", "label": "Submen√∫ 1", "icon": "fa5s-icono1", "route": "/ruta1" },
        { "id": "sub2", "label": "Submen√∫ 2", "icon": "fa5s-icono2", "route": "/ruta2" }
      ]
    }
  ]
}
```

### Ubicaciones Est√°ndar por M√≥dulo

#### 1. ELEMENTOS DE PRIMER NIVEL (Men√∫s Principales)
- **Dashboard**: `{ "id": "dashboard", "route": "/dashboard" }`
- **Usuarios**: `{ "id": "usuarios", "route": "/usuarios_list" }`
- **√ìrdenes**: `{ "id": "orders", "route": "/orders" }`
- **Inventario**: `{ "id": "inventory", "route": "/inventory" }`
- **Reportes**: `{ "id": "reports", "route": "/reports" }`

#### 2. GRUPO "MATERIAS PRIMAS" (Submen√∫s de MP)
```json
{ "id": "materiasprimas", "label": "Materias Primas", "icon": "fa5s-vials", "children": [
  { "id": "mp_admin", "label": "Administraci√≥n", "route": "/materiasprimas_list" },
  { "id": "mp_recepcion", "label": "Recepci√≥n de Materia Prima", "route": "/materiasprimas_recepcion" },
  { "id": "mp_inventario", "label": "Inventario", "route": "/materiasprimas_inventario" },
  { "id": "mp_categorias", "label": "Categor√≠as", "route": "/categoriasmateriaprima_list" },
  { "id": "mp_almacenes", "label": "Almacenes MP", "route": "/materiasprimas_almacenes" },
  { "id": "mp_proveedores", "label": "Proveedores", "route": "/proveedores_list" }
]}
```

#### 3. GRUPO "CONFIGURACI√ìN" (Administraci√≥n del Sistema)
```json
{ "id": "settings", "label": "Configuraci√≥n", "icon": "fa5s-cog", "children": [
  { "id": "roles", "label": "Roles", "route": "/roles_list" },
  // Agregar aqu√≠: configuraciones del sistema, par√°metros, etc.
]}
```

### Convenciones de Naming

#### IDs y Rutas:
- **M√≥dulos principales**: `id = nombre_modulo`, `route = "/nombre_modulo"`
- **Listados**: `route = "/modulo_list"` ‚Üí busca `/modulo/fxml/modulo_list.fxml`
- **Submen√∫s**: `id = "prefijo_nombre"` (ej. `mp_admin`, `mp_proveedores`)

#### Iconos FontAwesome 5 Solid (fa5s-):
- **Dashboard**: `fa5s-home`
- **Usuarios**: `fa5s-users` 
- **Inventario**: `fa5s-warehouse`, `fa5s-boxes`
- **Materias Primas**: `fa5s-vials`
- **Proveedores**: `fa5s-people-carry`, `fa5s-truck-loading`
- **Configuraci√≥n**: `fa5s-cog`, `fa5s-tools`
- **Reportes**: `fa5s-chart-line`, `fa5s-file-alt`
- **Categor√≠as**: `fa5s-tags`
- **Almacenes**: `fa5s-warehouse`
- **Seguridad**: `fa5s-user-shield`, `fa5s-lock`

### D√≥nde Agregar Nuevos M√≥dulos

#### Para un m√≥dulo INDEPENDIENTE:
1. Agregar al array principal `items` como elemento de primer nivel
2. Posici√≥n: despu√©s de elementos core, antes de "Configuraci√≥n"

#### Para subm√≥dulos de MATERIAS PRIMAS:
1. Agregar al array `children` del grupo `materiasprimas`
2. Usar prefijo `mp_` en el ID
3. Mantener orden l√≥gico: Admin ‚Üí Operaciones ‚Üí Maestros

#### Para subm√≥dulos de CONFIGURACI√ìN:
1. Agregar al array `children` del grupo `settings`  
2. Usar descripci√≥n clara del tipo de configuraci√≥n

#### Para nuevos GRUPOS:
1. Agregar antes del grupo "Configuraci√≥n"
2. Estructura completa con `children` array
3. √çcono representativo del √°rea funcional

### Resoluci√≥n de Rutas
- **Sistema autom√°tico**: `/ruta` ‚Üí busca `/fxml/ruta.fxml`
- **Con m√≥dulo**: `/modulo_list` ‚Üí busca `/modulo/fxml/modulo_list.fxml`
- **Log**: `[DashboardController] navigate received route='/ruta'`

### Estilos CSS del Men√∫
- **Sidebar**: `.app-sidebar` (contenedor principal)
- **T√≠tulo**: `.sidebar-title` 
- **Botones**: `.sidebar-button` (elementos principales)
- **Submen√∫s**: `.sidebar-child` (elementos anidados)
- **Iconos**: `.sidebar-icon`
- **Usuario**: `.sidebar-user-name`

## Men√∫ lateral (sidebar)
- Manifiesto: `src/main/resources/menu-manifest.json`.
- Grupos colapsables con indicador `+ / ‚àí` (fallback emoji `‚ûï / ‚àí`).
- Estilos en `css/dashboard.css`: `.app-sidebar`, `.sidebar-button`, `.sidebar-child`, `.sidebar-icon`, `.sidebar-user-name`.

## Est√°ndares de API ‚Äì Cliente Java
- Rutas preferidas v1 con guiones (ej.: `/api/v1/materias-primas`).
- Compatibilidad legacy: intentar v1 y, si falla, legacy.
- `ApiClient` a√±ade `Accept: application/json` y toma `baseUrl` de `config.ini`. En login hay autodetecci√≥n (https:5001 / http:5000) y actualizaci√≥n del `config.ini`.

## Est√°ndares de API ‚Äì ASP.NET Core
- Controllers con rutas base v1 y, si aplica, legacy:
  - `[Route("api/v1/materias-primas")]` y `[Route("api/materiasprimas")]`.
- Toggle de estado:
  - Acepta `PUT` y `PATCH`; rutas `toggle-estado` y `toggle-activo`.
  - Servicio con `ToggleEstadoAsync(id)` (invierte flag y guarda). Action devuelve `204` o `404`.
- Update con validaci√≥n y errores claros:
  - 400 si faltan requeridos o hay valores inv√°lidos.
  - 409 para conflictos de BD (√∫nica/for√°nea).
  - 500 solo para errores inesperados (ProblemDetails con detalle).
- Normalizaci√≥n de datos: si llega `materiaPrimaOrigenId=0` en `Create/Update`, convertir a `null` (sin origen).

## Materias Primas ‚Äì Implementaci√≥n de referencia
- Lista (DTO real):
  - Columnas: ID, Nombre, C√≥digo Interno, Unidad, Categor√≠a, Origen, Activa (toggle), Stock Actual, Stock M√≠n, Stock M√°x, Costo Unitario, Acciones.
  - B√∫squeda: por nombre, c√≥digo, categor√≠a y origen.
  - Exportaci√≥n: usa `ExportBar`; los campos ajenos al DTO est√°n `@JsonIgnore` en el modelo para no exportarlos.
- Formulario:
  - Unidad: ComboBox desde `/api/UnidadesMedida` (muestra `abreviatura - nombre`; env√≠a abreviatura en `unidad`).
  - Categor√≠a: ComboBox desde `/api/CategoriasMateriaPrima` (muestra `id - nombre`).
  - Origen: ComboBox con materias existentes; opcional (se env√≠a `null` si no aplica).
  - Edici√≥n: precarga combos; si cargan as√≠ncronos se seleccionan cuando llegan (selecci√≥n pendiente).
  - Bot√≥n ‚ÄúCrear/Actualizar‚Äù con cambio de clase y texto seg√∫n modo.

## Buenas pr√°cticas
- Mantener los DTOs del cliente alineados 1:1 con el backend.
- No exportar campos que no pertenezcan al DTO (usar `@JsonIgnore`).
- En JavaFX:
  - `CONSTRAINED_RESIZE_POLICY` en tablas; `prefWidth` por columna.
  - Buscar con `SearchBar` y reiniciar p√°gina a 0 al cambiar filtro.
  - Insertar `ExportBar` antes del paginador; acciones Editar/Eliminar en columna ‚ÄúAcciones‚Äù.
- En ASP.NET Core:
  - Validar DTOs y devolver 400; usar 204/404 en toggles; 409 en conflictos; limitar 500 a errores inesperados.

## RESUMEN DE COMPONENTES OBLIGATORIOS

### LISTADO (.fxml + Controller):
1. ‚úÖ **ExportBar**: En `exportBarContainer`, alineado a la derecha, con callback `() -> service.listAll()`
2. ‚úÖ **TableView**: Con `CONSTRAINED_RESIZE_POLICY_FLEX_LAST_COLUMN`
3. ‚úÖ **Columnas est√°ndar**: ID (80px), Nombre (200px), Estado (100px), Acciones (150px)
4. ‚úÖ **SwitchToggleButton**: Para columna estado/activo, 48x26px, clase `cell-switch-btn`
5. ‚úÖ **Botones de acci√≥n**: Editar (`button-yellow`), Eliminar (`button-red`), ambos `btn-small icon-btn`
6. ‚úÖ **Bot√≥n Nuevo**: `button-blue btn-primary icon-btn` + "‚ûï Nuevo"
7. ‚úÖ **SearchBar**: Con reinicio de p√°gina en cambio de filtro
8. ‚úÖ **PaginatorControl**: Al final del layout
9. ‚úÖ **Manejo de errores**: MessageToast para errores de carga/toggle/eliminaci√≥n

### FORMULARIO (.fxml + Controller):
1. ‚úÖ **Estructura modal**: BorderPane + modal-accent + modal-header + StackPane
2. ‚úÖ **Botones obligatorios**: 
   - Crear: `btn-action-create` (verde)
   - Actualizar: `btn-action-update` (azul) 
   - Cancelar: `btn-action-cancel` (rojo)
3. ‚úÖ **Estados de UI**: Loading (progress + overlay), error (lblError), disable en loading
4. ‚úÖ **Modo edici√≥n**: Cambio de t√≠tulo, texto bot√≥n y clase CSS
5. ‚úÖ **Validaci√≥n b√°sica**: Campos requeridos con mensajes de error
6. ‚úÖ **Callback**: `setOnSaved(Runnable)` para recargar listado

### API SERVICE:
1. ‚úÖ **M√©todos est√°ndar**: `listAll()`, `getById()`, `create()`, `update()`, `delete()`, `toggleEstado()`
2. ‚úÖ **Rutas v1**: Preferir `/api/v1/<modulo-plural>` con fallback a legacy
3. ‚úÖ **Manejo de errores**: Propagaci√≥n de excepciones para manejo en UI

### ESTILOS OBLIGATORIOS:
1. ‚úÖ **Colores de botones**:
   - Verde: `button-green` (Excel, Crear)
   - Azul: `button-blue` (CSV, Nuevo, Actualizar)  
   - Rojo: `button-red` (Eliminar, Cancelar)
   - Amarillo: `button-yellow` (Editar)
   - Gris: `button-gray` (TXT)
   - Morado: `button-purple` (PDF)
2. ‚úÖ **Utilidades**: `btn-small`, `icon-btn`, `btn-primary`
3. ‚úÖ **Modal**: `modal-card`, `modal-accent`, `modal-header`

Con esta gu√≠a, para cualquier m√≥dulo nuevo:
- Listado = TableView + SearchBar + ExportBar + Paginador + Acciones + Toggle (si aplica)
- Formulario modal = Estructura est√°ndar + combos desde API + botones con clases globales
- Endpoints = v1 con guiones + toggles idempotentes + validaci√≥n consistente + normalizaci√≥n de campos opcionales

## Plantilla de M√≥dulo (copiar/pegar y renombrar)

Sustituir `<modulo>` por el nombre del m√≥dulo (snake_case para rutas, camel/pascal para clases) y ajustar DTO/columnas.

1) FXML listado ‚Äì `src/main/resources/<modulo>/fxml/<modulo>_list.fxml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import com.tracersoftware.common.controls.PaginatorControl?>
<?import com.tracersoftware.common.controls.SearchBar?>
<BorderPane xmlns:fx="http://javafx.com/fxml/1" fx:controller="com.tracersoftware.<modulo>.controller.<Modulo>ListController">
    <center>
        <VBox spacing="8" style="-fx-padding:12;" fillWidth="true">
            <!-- OBLIGATORIO: Header con t√≠tulo, SearchBar y bot√≥n Nuevo -->
            <HBox spacing="8" alignment="CENTER_LEFT">
                <Label text="T√≠tulo del M√≥dulo" style="-fx-font-size:16px; -fx-font-weight:bold;" />
                <Region HBox.hgrow="ALWAYS" />
                <SearchBar fx:id="searchBar" />
                <Button fx:id="btnNuevo" text="Nuevo" />
            </HBox>
            
            <!-- OBLIGATORIO: Contenedor para ExportBar (alineado a la derecha) -->
            <HBox fx:id="exportBarContainer" spacing="8" alignment="CENTER_RIGHT" />
            
            <!-- OBLIGATORIO: Tabla principal con columnas est√°ndar -->
            <TableView fx:id="table" VBox.vgrow="ALWAYS">
                <columns>
                    <TableColumn text="ID" fx:id="colId" />
                    <TableColumn text="Nombre" fx:id="colNombre" />
                    <!-- Agregar columnas espec√≠ficas del DTO -->
                    <TableColumn text="Activo" fx:id="colActivo" />
                    <TableColumn text="Acciones" fx:id="colAcciones" />
                </columns>
            </TableView>
            
            <!-- OBLIGATORIO: Paginador al final -->
            <PaginatorControl fx:id="paginator" />
        </VBox>
    </center>
</BorderPane>
```

2) Controlador listado ‚Äì `src/main/java/com/tracersoftware/<modulo>/controller/<Modulo>ListController.java`

```java
package com.tracersoftware.<modulo>.controller;

import com.tracersoftware.common.controls.MessageToast;
import com.tracersoftware.common.controls.SwitchToggleButton;
import com.tracersoftware.<modulo>.api.<Modulo>ApiService;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.concurrent.Task;
import javafx.fxml.FXML;
import javafx.scene.Parent;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;

public class <Modulo>ListController implements com.tracersoftware.ui.ViewLifecycle {
    @FXML private TableView<com.tracersoftware.<modulo>.model.<Modulo>Item> table;
    @FXML private TableColumn<com.tracersoftware.<modulo>.model.<Modulo>Item,Integer> colId;
    @FXML private TableColumn<com.tracersoftware.<modulo>.model.<Modulo>Item,String> colNombre;
    @FXML private TableColumn<com.tracersoftware.<modulo>.model.<Modulo>Item,Boolean> colActivo;
    @FXML private TableColumn<com.tracersoftware.<modulo>.model.<Modulo>Item,Void> colAcciones;
    @FXML private com.tracersoftware.common.controls.PaginatorControl paginator;
    @FXML private com.tracersoftware.common.controls.SearchBar searchBar;
    @FXML private Button btnNuevo;
    @FXML private javafx.scene.layout.HBox exportBarContainer; // OBLIGATORIO

    private final <Modulo>ApiService service = new <Modulo>ApiService();
    private final ObservableList<com.tracersoftware.<modulo>.model.<Modulo>Item> data = FXCollections.observableArrayList();
    private final java.util.List<com.tracersoftware.<modulo>.model.<Modulo>Item> full = new java.util.ArrayList<>();

    @FXML public void initialize() {
        // OBLIGATORIO: Configuraci√≥n de tabla
        if (table != null) {
            table.setItems(data);
            table.setColumnResizePolicy(TableView.CONSTRAINED_RESIZE_POLICY_FLEX_LAST_COLUMN);
        }
        
        // OBLIGATORIO: Configuraci√≥n de columnas con anchos est√°ndar
        if (colId != null) {
            colId.setCellValueFactory(new PropertyValueFactory<>("id"));
            colId.setPrefWidth(80);
        }
        if (colNombre != null) {
            colNombre.setCellValueFactory(new PropertyValueFactory<>("nombre"));
            colNombre.setPrefWidth(200);
        }
        if (colActivo != null) {
            colActivo.setCellValueFactory(new PropertyValueFactory<>("activo"));
            colActivo.setPrefWidth(100);
        }
        if (colAcciones != null) {
            colAcciones.setPrefWidth(150);
        }
        
        // OBLIGATORIO: Toggle estado con SwitchToggleButton
        if (colActivo != null) colActivo.setCellFactory(tc -> new TableCell<>() {
            private final SwitchToggleButton sw = new SwitchToggleButton();
            private boolean prog = false;
            {
                sw.setMinWidth(48); sw.setPrefWidth(48); sw.setMaxWidth(48);
                sw.setMinHeight(26); sw.setPrefHeight(26); sw.setMaxHeight(26);
                sw.getStyleClass().add("cell-switch-btn");
                sw.switchedOnProperty().addListener((o,ov,nv) -> {
                    if (prog) return;
                    int idx = getIndex(); 
                    if (idx < 0 || idx >= getTableView().getItems().size()) return;
                    var row = getTableView().getItems().get(idx);
                    boolean ns = Boolean.TRUE.equals(nv);
                    sw.setDisable(true);
                    Task<Void> t = new Task<>() { 
                        @Override protected Void call() throws Exception { 
                            service.toggleEstado(row.getId(), ns); 
                            return null; 
                        } 
                    };
                    t.setOnSucceeded(e -> { row.setActivo(ns); sw.setDisable(false); });
                    t.setOnFailed(e -> { 
                        sw.setDisable(false); 
                        prog = true; 
                        sw.setSelected(!ns); 
                        prog = false; 
                        MessageToast.showSystemError(null, "Error al cambiar estado"); 
                    });
                    new Thread(t, "<modulo>-toggle").start();
                });
            }
            @Override protected void updateItem(Boolean item, boolean empty) {
                super.updateItem(item, empty);
                if (empty) { setGraphic(null); return; }
                prog = true; sw.setSelected(Boolean.TRUE.equals(item)); prog = false;
                setGraphic(sw);
            }
        });
        
        // OBLIGATORIO: Columna acciones con botones estilizados
        if (colAcciones != null) colAcciones.setCellFactory(tc -> new TableCell<>() {
            private final Button btnEdit = new Button("Editar");
            private final Button btnDel = new Button("Eliminar");
            private final javafx.scene.layout.HBox box = new javafx.scene.layout.HBox(6, btnEdit, btnDel);
            { 
                btnEdit.getStyleClass().addAll("btn-small", "button-yellow", "icon-btn"); 
                btnDel.getStyleClass().addAll("btn-small", "button-red", "icon-btn");
                btnEdit.setOnAction(e -> {
                    int idx = getIndex(); 
                    if (idx < 0 || idx >= getTableView().getItems().size()) return;
                    var item = getTableView().getItems().get(idx);
                    if (item != null) openForm(item);
                });
                btnDel.setOnAction(e -> {
                    int idx = getIndex(); 
                    if (idx < 0 || idx >= getTableView().getItems().size()) return;
                    var item = getTableView().getItems().get(idx);
                    if (item != null) deleteItem(item);
                });
            }
            @Override protected void updateItem(Void item, boolean empty) {
                super.updateItem(item, empty); 
                setGraphic(empty ? null : box);
            }
        });
        
        // OBLIGATORIO: ExportBar en contenedor dedicado
        if (exportBarContainer != null) {
            com.tracersoftware.common.controls.ExportBar exportBar = 
                new com.tracersoftware.common.controls.ExportBar(table, "<modulo>", () -> service.listAll());
            javafx.scene.layout.Region spacer = new javafx.scene.layout.Region();
            javafx.scene.layout.HBox.setHgrow(spacer, javafx.scene.layout.Priority.ALWAYS);
            exportBarContainer.getChildren().addAll(spacer, exportBar);
        }
        
        // OBLIGATORIO: B√∫squeda y paginaci√≥n
        if (searchBar != null) searchBar.textProperty().addListener((o,ov,nv) -> { 
            if (paginator != null) paginator.setPageIndex(0); 
            applyPage(); 
        });
        if (paginator != null) { 
            paginator.pageIndexProperty().addListener((o,ov,nv) -> applyPage()); 
            paginator.pageSizeProperty().addListener((o,ov,nv) -> applyPage()); 
        }
        
        // OBLIGATORIO: Bot√≥n nuevo con estilos est√°ndar
        if (btnNuevo != null) {
            btnNuevo.getStyleClass().addAll("button-blue", "btn-primary", "icon-btn"); 
            btnNuevo.setText("‚ûï Nuevo");
            btnNuevo.setOnAction(e -> openForm(null));
        }
    }

    @Override public void onViewShown() { load(); }
    
    private void load() {
        Task<java.util.List<com.tracersoftware.<modulo>.model.<Modulo>Item>> t = new Task<>() { 
            @Override protected java.util.List<com.tracersoftware.<modulo>.model.<Modulo>Item> call() throws Exception { 
                return service.listAll(); 
            } 
        };
        t.setOnSucceeded(e -> { 
            full.clear(); 
            if (t.getValue() != null) full.addAll(t.getValue()); 
            applyPage(); 
        });
        t.setOnFailed(e -> {
            MessageToast.showSystemError(null, "Error cargando datos: " + 
                (t.getException() == null ? "" : t.getException().getMessage()));
        });
        new Thread(t, "<modulo>-load").start();
    }
    
    private void applyPage() {
        String q = searchBar != null && searchBar.getText() != null ? 
                   searchBar.getText().trim().toLowerCase() : "";
        java.util.List<com.tracersoftware.<modulo>.model.<Modulo>Item> filtered = new java.util.ArrayList<>();
        for (var it : full) { 
            if (q.isEmpty() || (it.getNombre() + " " + it.getId()).toLowerCase().contains(q)) 
                filtered.add(it); 
        }
        int page = paginator != null ? paginator.getPageIndex() : 0;
        int size = paginator != null ? paginator.getPageSize() : Math.max(1, filtered.size());
        int total = filtered.size(); 
        int from = Math.max(0, Math.min(page * size, total)); 
        int to = Math.max(from, Math.min(from + size, total));
        data.setAll(filtered.subList(from, to));
        if (paginator != null) paginator.setTotalItems(total);
    }
    
    private void deleteItem(com.tracersoftware.<modulo>.model.<Modulo>Item item) {
        Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
        alert.setTitle("Confirmar eliminaci√≥n");
        alert.setHeaderText("¬øEst√° seguro de eliminar este registro?");
        alert.setContentText("Nombre: " + item.getNombre());
        
        alert.showAndWait().ifPresent(response -> {
            if (response == ButtonType.OK) {
                Task<Void> deleteTask = new Task<>() {
                    @Override protected Void call() throws Exception {
                        service.delete(item.getId());
                        return null;
                    }
                };
                deleteTask.setOnSucceeded(e -> {
                    MessageToast.show(null, "Registro eliminado exitosamente", MessageToast.ToastType.SUCCESS);
                    load();
                });
                deleteTask.setOnFailed(e -> {
                    MessageToast.showSystemError(null, "Error al eliminar: " + 
                        (deleteTask.getException() == null ? "" : deleteTask.getException().getMessage()));
                });
                new Thread(deleteTask, "<modulo>-delete").start();
            }
        });
    }
    
    private void openForm(com.tracersoftware.<modulo>.model.<Modulo>Item item) {
        try {
            javafx.fxml.FXMLLoader loader = new javafx.fxml.FXMLLoader(
                getClass().getResource("/<modulo>/fxml/<modulo>_form.fxml"));
            Parent root = loader.load();
            var controller = loader.getController();
            
            // OBLIGATORIO: Establecer callback para actualizaci√≥n autom√°tica
            controller.setOnSaved(this::load);
            
            // Configurar modo seg√∫n si es creaci√≥n o edici√≥n
            if (item != null) {
                controller.edit(item);
            } else {
                controller.create();
            }
            
            com.tracersoftware.common.ui.ModalUtils.showModalAndWait(
                null, root, item == null ? "Nuevo" : "Editar");
        } catch (Exception ex) { 
            MessageToast.showSystemError(null, "No se pudo abrir el formulario: " + ex.getMessage()); 
        }
    }
}
```

3) FXML formulario ‚Äì `src/main/resources/<modulo>/fxml/<modulo>_form.fxml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<BorderPane xmlns:fx="http://javafx.com/fxml/1" fx:controller="com.tracersoftware.<modulo>.controller.<Modulo>FormController" styleClass="modal-card">
    <!-- OBLIGATORIO: Barra superior para drag del modal -->
    <top>
        <Pane minHeight="15" prefHeight="15" maxHeight="15" styleClass="modal-accent" />
    </top>
    <center>
        <VBox spacing="4">
            <!-- OBLIGATORIO: Header del modal -->
            <HBox styleClass="modal-header">
                <Label fx:id="lblTitle" text="Nuevo" />
            </HBox>
            <StackPane>
                <!-- OBLIGATORIO: Grid principal con campos -->
                <GridPane hgap="10" vgap="10">
                    <padding>
                        <Insets top="14" right="14" bottom="14" left="14" />
                    </padding>
                    <columnConstraints>
                        <ColumnConstraints halignment="RIGHT" minWidth="110" prefWidth="120" />
                        <ColumnConstraints hgrow="ALWAYS" minWidth="240" prefWidth="300" />
                    </columnConstraints>
                    
                    <!-- Campos espec√≠ficos del m√≥dulo -->
                    <Label text="Nombre:" GridPane.rowIndex="0" GridPane.columnIndex="0" />
                    <TextField fx:id="txtNombre" GridPane.rowIndex="0" GridPane.columnIndex="1" prefWidth="300" />
                    
                    <Label text="Activo:" GridPane.rowIndex="1" GridPane.columnIndex="0" />
                    <CheckBox fx:id="chkActivo" GridPane.rowIndex="1" GridPane.columnIndex="1" selected="true" />
                    
                    <!-- OBLIGATORIO: Label de error -->
                    <Label fx:id="lblError" textFill="red" wrapText="true" visible="false" managed="false" 
                           GridPane.rowIndex="8" GridPane.columnIndex="0" GridPane.columnSpan="2" />
                    
                    <!-- OBLIGATORIO: Botones con estilos est√°ndar -->
                    <HBox spacing="10" alignment="CENTER_RIGHT" GridPane.rowIndex="9" GridPane.columnIndex="1">
                        <ProgressIndicator fx:id="progress" prefWidth="20" prefHeight="20" visible="false" />
                        <Button fx:id="btnSave" text="Crear" styleClass="btn-action-create" />
                        <Button fx:id="btnCancel" text="Cancelar" styleClass="btn-action-cancel" />
                    </HBox>
                </GridPane>
                
                <!-- OBLIGATORIO: Overlay para loading -->
                <AnchorPane fx:id="overlay" visible="false" pickOnBounds="false" 
                           style="-fx-background-color: rgba(0,0,0,0.35);">
                    <children>
                        <ProgressIndicator fx:id="overlayProgress" prefWidth="64" prefHeight="64" 
                                         AnchorPane.topAnchor="0" AnchorPane.bottomAnchor="0"
                                         AnchorPane.leftAnchor="0" AnchorPane.rightAnchor="0" />
                    </children>
                </AnchorPane>
            </StackPane>
        </VBox>
    </center>
</BorderPane>
```

4) Controlador formulario ‚Äì `src/main/java/com/tracersoftware/<modulo>/controller/<Modulo>FormController.java`

```java
package com.tracersoftware.<modulo>.controller;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.tracersoftware.common.controls.MessageToast;
import com.tracersoftware.<modulo>.api.<Modulo>ApiService;
import com.tracersoftware.<modulo>.model.<Modulo>Item;
import javafx.application.Platform;
import javafx.concurrent.Task;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import javafx.scene.layout.AnchorPane;
import javafx.stage.Stage;

public class <Modulo>FormController {
    @FXML private Label lblTitle;
    @FXML private TextField txtNombre;
    @FXML private CheckBox chkActivo;
    @FXML private Label lblError;
    @FXML private ProgressIndicator progress;
    @FXML private Button btnSave;
    @FXML private Button btnCancel;
    @FXML private AnchorPane overlay;
    @FXML private ProgressIndicator overlayProgress;

    private final <Modulo>ApiService service = new <Modulo>ApiService();
    private final ObjectMapper mapper = new ObjectMapper();
    private boolean isEdit = false;
    private <Modulo>Item currentItem;
    private Runnable onSaved;

    @FXML public void initialize() {
        // OBLIGATORIO: Configuraci√≥n de botones
        btnCancel.setOnAction(e -> closeModal());
        btnSave.setOnAction(e -> save());
        
        // OBLIGATORIO: Configuraci√≥n inicial de elementos
        lblError.setVisible(false);
        lblError.setManaged(false);
        progress.setVisible(false);
        overlay.setVisible(false);
    }

    public void setOnSaved(Runnable callback) {
        this.onSaved = callback;
    }

    // OBLIGATORIO: M√©todo para modo edici√≥n
    public void edit(<Modulo>Item item) {
        this.isEdit = true;
        this.currentItem = item;
        
        // OBLIGATORIO: Cambiar estilos y texto del bot√≥n
        lblTitle.setText("Editar");
        btnSave.setText("Actualizar");
        btnSave.getStyleClass().removeAll("btn-action-create");
        btnSave.getStyleClass().add("btn-action-update");
        
        // Cargar datos en los campos
        txtNombre.setText(item.getNombre());
        chkActivo.setSelected(item.isActivo());
    }

    private void save() {
        // OBLIGATORIO: Validaci√≥n b√°sica
        String nombre = txtNombre.getText();
        if (nombre == null || nombre.trim().isEmpty()) {
            showError("El nombre es obligatorio");
            return;
        }

        // OBLIGATORIO: Mostrar loading
        showLoading(true);
        hideError();

        Task<Void> task = new Task<>() {
            @Override
            protected Void call() throws Exception {
                ObjectNode body = mapper.createObjectNode();
                body.put("nombre", nombre.trim());
                body.put("activo", chkActivo.isSelected());
                
                if (isEdit && currentItem != null) {
                    service.update(currentItem.getId(), body);
                } else {
                    service.create(body);
                }
                return null;
            }
        };

        task.setOnSucceeded(e -> {
            Platform.runLater(() -> {
                showLoading(false);
                MessageToast.show(null, 
                    isEdit ? "Registro actualizado exitosamente" : "Registro creado exitosamente", 
                    MessageToast.ToastType.SUCCESS);
                if (onSaved != null) onSaved.run();
                closeModal();
            });
        });

        task.setOnFailed(e -> {
            Platform.runLater(() -> {
                showLoading(false);
                Throwable ex = task.getException();
                String errorMsg = ex != null ? ex.getMessage() : "Error desconocido";
                showError("Error al guardar: " + errorMsg);
            });
        });

        new Thread(task, "<modulo>-save").start();
    }

    // OBLIGATORIO: M√©todos de utilidad para UI
    private void showError(String message) {
        lblError.setText(message);
        lblError.setVisible(true);
        lblError.setManaged(true);
    }

    private void hideError() {
        lblError.setVisible(false);
        lblError.setManaged(false);
    }

    private void showLoading(boolean show) {
        progress.setVisible(show);
        overlay.setVisible(show);
        btnSave.setDisable(show);
        btnCancel.setDisable(show);
    }

    private void closeModal() {
        Stage stage = (Stage) btnCancel.getScene().getWindow();
        stage.close();
    }
}
```

4) Servicio cliente Java ‚Äì `src/main/java/com/tracersoftware/<modulo>/api/<Modulo>ApiService.java`

```
package com.tracersoftware.<modulo>.api;
import com.fasterxml.jackson.databind.JsonNode;
import com.tracersoftware.api.ApiClient;
import java.io.IOException; import java.util.List; import java.util.ArrayList;

public class <Modulo>ApiService {
    private final ApiClient api = new ApiClient();
    public List<com.tracersoftware.<modulo>.model.<Modulo>Item> listAll() throws Exception {
        JsonNode root = api.getJson("/api/v1/<modulo-plural>");
        List<com.tracersoftware.<modulo>.model.<Modulo>Item> out = new ArrayList<>();
        if (root!=null && root.isArray()) for (JsonNode n: root) { /* mapear */ }
        return out;
    }
    public JsonNode getById(int id) throws Exception { return api.getJson("/api/v1/<modulo-plural>/"+id); }
    public JsonNode create(JsonNode body) throws Exception { return api.postJson("/api/v1/<modulo-plural>", body.toString()); }
    public JsonNode update(int id, JsonNode body) throws Exception { return api.putJson("/api/v1/<modulo-plural>/"+id, body.toString()); }
    public void delete(int id) throws Exception { api.deleteJson("/api/v1/<modulo-plural>/"+id); }
    public JsonNode toggleEstado(int id, boolean activo) throws Exception {
        com.fasterxml.jackson.databind.node.ObjectNode b = new com.fasterxml.jackson.databind.ObjectMapper().createObjectNode();
        b.put("activo", activo); return api.putJson("/api/v1/<modulo-plural>/"+id+"/toggle-estado", b.toString());
    }
}
```

5) Backend (ASP.NET Core) ‚Äì Controller de referencia

```
[ApiController]
[Route("api/v1/<modulo-plural>")]
[Route("api/<modulo-legacy>")] // opcional compatibilidad
public class <ModuloPlural>Controller : ControllerBase {
    private readonly I<Modulo>Service _service;
    public <ModuloPlural>Controller(I<Modulo>Service service){ _service = service; }

    [HttpGet] public Task<List<<Modulo>DTO>> GetAll() => _service.GetAllAsync();
    [HttpGet("{id}")] public async Task<ActionResult<<Modulo>DTO>> GetById(int id){ var r=await _service.GetByIdAsync(id); return r==null?NotFound():r; }
    [HttpPost] public async Task<ActionResult<<Modulo>DTO>> Create([FromBody] <Modulo>CreateDTO dto){ var c=await _service.CreateAsync(dto); return CreatedAtAction(nameof(GetById), new { id=c.Id }, c); }
    [HttpPut("{id}")]
    public async Task<IActionResult> Update(int id, [FromBody] <Modulo>CreateDTO dto){ /* validar dto */ var ok=await _service.UpdateAsync(id,dto); return ok?NoContent():NotFound(); }
    [HttpDelete("{id}")] public async Task<IActionResult> Delete(int id){ var ok=await _service.DeleteAsync(id); return ok?NoContent():NotFound(); }
    [HttpPut("{id}/toggle-estado")][HttpPatch("{id}/toggle-estado")][HttpPut("{id}/toggle-activo")]
    public async Task<IActionResult> ToggleEstado(int id){ var ok=await _service.ToggleEstadoAsync(id); return ok?NoContent():NotFound(); }
}
```
